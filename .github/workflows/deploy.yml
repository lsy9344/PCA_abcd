name: ğŸš€ Deploy to AWS Lambda Container

on:
  push:
    branches: [workflow]  # ë˜ëŠ” main
  workflow_dispatch:

env:
  REGION: ap-northeast-2
  FUNCTION_NAME: parkingauto_250707
  IMAGE_NAME: parking_auto_ecrrepo_2

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.REGION }}

    - name: ğŸ§­ Init status (for Slack)
      run: echo "STATUS=Unknown" >> $GITHUB_ENV

    - name: âœ… Check AWS identity (STS)
      run: aws sts get-caller-identity

    - name: ğŸ§¹ Clean Docker environment
      run: |
        export DOCKER_BUILDKIT=0
        docker system prune -af

    - name: ğŸ”“ Login to Amazon ECR
      run: |
        REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.REGION }}.amazonaws.com"
        aws ecr get-login-password --region ${{ env.REGION }} \
          | docker login --username AWS --password-stdin "$REGISTRY"

    - name: ğŸ›  Build Docker image (linux/amd64)
      run: |
        export DOCKER_BUILDKIT=0
        REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.REGION }}.amazonaws.com"
        REPO="${{ env.IMAGE_NAME }}"
        IMAGE_URI="$REGISTRY/$REPO:latest"

        docker build --platform linux/amd64 --no-cache -t "$REPO:latest" .
        ARCH=$(docker inspect "$REPO:latest" --format '{{.Architecture}}')
        echo "ë¹Œë“œëœ ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜: $ARCH"
        if [ "$ARCH" != "amd64" ]; then
          echo "âŒ ì˜ëª»ëœ ì•„í‚¤í…ì²˜: $ARCH (amd64 í•„ìš”)"
          echo "STATUS=Build Failed" >> $GITHUB_ENV
          exit 1
        fi

        docker tag "$REPO:latest" "$IMAGE_URI"
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    - name: ğŸ” Check ECR repository exists
      run: |
        aws ecr describe-repositories \
          --repository-names "${{ env.IMAGE_NAME }}" \
          --region "${{ env.REGION }}"

    - name: ğŸ“¤ Push to Amazon ECR
      run: |
        docker push "${IMAGE_URI}"

    - name: â³ Lambda í•¨ìˆ˜ ìƒíƒœ í™•ì¸ (ì‚¬ì „)
      run: |
        STATUS=$(aws lambda get-function --function-name ${{ env.FUNCTION_NAME }} --region ${{ env.REGION }} --query 'Configuration.LastUpdateStatus' --output text || echo "Unknown")
        echo "í˜„ì¬ Lambda í•¨ìˆ˜ ìƒíƒœ: $STATUS"
        while [ "$STATUS" = "InProgress" ]; do
          sleep 10
          STATUS=$(aws lambda get-function --function-name ${{ env.FUNCTION_NAME }} --region ${{ env.REGION }} --query 'Configuration.LastUpdateStatus' --output text || echo "Unknown")
        done

    - name: ğŸ”„ Update Lambda function (to latest image)
      run: |
        aws lambda update-function-code \
          --function-name ${{ env.FUNCTION_NAME }} \
          --image-uri "${IMAGE_URI}" \
          --region ${{ env.REGION }} \
          --architectures "x86_64"

    - name: â³ Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°
      run: |
        for i in {1..30}; do
          STATUS=$(aws lambda get-function --function-name ${{ env.FUNCTION_NAME }} --region ${{ env.REGION }} --query 'Configuration.LastUpdateStatus' --output text)
          if [ "$STATUS" = "Successful" ]; then
            echo "âœ… Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
            echo "STATUS=Successful" >> $GITHUB_ENV
            break
          elif [ "$STATUS" = "Failed" ]; then
            echo "âŒ Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
            echo "STATUS=Failed" >> $GITHUB_ENV
            exit 1
          else
            sleep 10
          fi
        done

    - name: ğŸ§ª Lambda í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ í˜¸ì¶œ
      run: |
        aws lambda invoke \
          --function-name ${{ env.FUNCTION_NAME }} \
          --region ${{ env.REGION }} \
          --payload '{}' \
          response.json
        if grep -q "errorMessage" response.json; then
          echo "âŒ Lambda í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          echo "STATUS=Test Failed" >> $GITHUB_ENV
          cat response.json
          exit 1
        else
          echo "âœ… Lambda í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
        fi

    - name: ğŸ“Š ë°°í¬ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ“Š ===== ë°°í¬ ê²°ê³¼ ìš”ì•½ ====="
        echo "ğŸ·ï¸  ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}"
        echo "ğŸš€ í•¨ìˆ˜: ${{ env.FUNCTION_NAME }}"
        echo "ğŸŒ ë¦¬ì „: ${{ env.REGION }}"
        echo "ğŸ–¼  ì´ë¯¸ì§€ URI: ${IMAGE_URI:-N/A}"
        echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
        STATUS=$(aws lambda get-function --function-name ${{ env.FUNCTION_NAME }} --region ${{ env.REGION }} --query 'Configuration.LastUpdateStatus' --output text 2>/dev/null || echo "${{ env.STATUS }}")
        echo "ìµœì¢… ìƒíƒœ: $STATUS"
        echo "STATUS=$STATUS" >> $GITHUB_ENV

    - name: ğŸ“£ Slack Notification
      if: always()
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": ":rocket: *AWS Lambda ë°°í¬ ê²°ê³¼ ì•Œë¦¼*\n*ê²°ê³¼*: `${{ env.STATUS }}`\ní•¨ìˆ˜ëª…: `${{ env.FUNCTION_NAME }}`\në¦¬ì „: `${{ env.REGION }}`\nì´ë¯¸ì§€: `${{ env.IMAGE_NAME }}`\n*GitHub Workflow*: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì—¬ê¸°ì„œ ìì„¸íˆ ë³´ê¸°>"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}