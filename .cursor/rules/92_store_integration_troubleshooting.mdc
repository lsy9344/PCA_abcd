---
title: "ë§¤ì¥ í†µí•© ë° ë¬¸ì œ í•´ê²° ì¢…í•© ê°€ì´ë“œ"
order: 92
category: "guide"
alwaysApply: true
tags: ["store-integration", "troubleshooting", "config", "parsing", "page-safety"]
lastUpdated: "2025-08-19"
description: "ìƒˆ ë§¤ì¥ ì¶”ê°€ ì‹œ ë°œìƒí•˜ëŠ” ê³µí†µ ë¬¸ì œë“¤ê³¼ ì²´ê³„ì ì¸ í•´ê²° ë°©ë²•"
---

# ë§¤ì¥ í†µí•© ë° ë¬¸ì œ í•´ê²° ì¢…í•© ê°€ì´ë“œ

## ğŸ¯ ëª©ì 

ìƒˆë¡œìš´ ë§¤ì¥ì„ ì‹œìŠ¤í…œì— í†µí•©í•  ë•Œ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ë¬¸ì œë“¤ì„ ì‚¬ì „ì— ë°©ì§€í•˜ê³ , ë°œìƒ ì‹œ ë¹ ë¥´ê²Œ í•´ê²°í•  ìˆ˜ ìˆëŠ” ì²´ê³„ì ì¸ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.

---

## ğŸš¨ ê³µí†µ ë¬¸ì œ íŒ¨í„´ ë° í•´ê²° ì „ëµ

### **1. ì„¤ì • ë¡œë” ë¶ˆì¼ì¹˜ ë¬¸ì œ**

#### **ì¦ìƒ**
```
âŒ AttributeError: 'StoreConfig' object has no attribute 'discount_types'
âŒ KeyError: 'coupon_key_mapping'
```

#### **ì›ì¸**
- ì„œë¡œ ë‹¤ë¥¸ `StoreConfig` í´ë˜ìŠ¤ ì‚¬ìš©
- ë¡œë” í•¨ìˆ˜ì™€ ConfigManager í˜¼ìš©

#### **í•´ê²° ë°©ë²•**
```python
# âŒ ì˜ëª»ëœ ë°©ì‹ - loader í•¨ìˆ˜ ì‚¬ìš©
from infrastructure.config.loader import load_store_config
store_config = load_store_config(store_id)  # discount_types ì†ì„± ì—†ìŒ

# âœ… ì˜¬ë°”ë¥¸ ë°©ì‹ - ConfigManager ì‚¬ìš©
from infrastructure.config.config_manager import ConfigManager
config_manager = ConfigManager()
store_config = config_manager.get_store_config(store_id)  # ì™„ì „í•œ ê°ì²´
```

#### **ê²€ì¦ ë°©ë²•**
```python
# ì„¤ì • ê°ì²´ ê²€ì¦
assert hasattr(store_config, 'discount_types')
assert hasattr(store_config, 'selectors')
assert 'coupon_key_mapping' in store_config.selectors.get('coupons', {})
```

---

### **2. í…Œì´ë¸” êµ¬ì¡° íŒŒì‹± ë¬¸ì œ**

#### **ì¦ìƒ**
```
âŒ ë§¤í•‘ ì‹¤íŒ¨: '1íšŒ' - ì•Œë ¤ì§„ ì¿ í°ëª…ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ
âŒ ìš°ë¦¬ ë§¤ì¥ í• ì¸ ë‚´ì—­ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
âŒ ë¹ˆ ì´ë ¥ ë°˜í™˜: my_history: {}, total_history: {}
```

#### **ì›ì¸**
- ì‹¤ì œ HTML êµ¬ì¡°ì™€ ì˜ˆìƒ êµ¬ì¡° ë¶ˆì¼ì¹˜
- ë§¤ì¥ë³„ í…Œì´ë¸” í˜•ì‹ ì°¨ì´ ë¬´ì‹œ
- í•˜ë“œì½”ë”©ëœ ì…€ ì¸ë±ìŠ¤ ì‚¬ìš©

#### **í•´ê²° ì „ëµ**

##### **STEP 1: HTML êµ¬ì¡° ë¶„ì„**
```python
# ë””ë²„ê¹… ì½”ë“œ ì¶”ê°€í•˜ì—¬ ì‹¤ì œ êµ¬ì¡° íŒŒì•…
for idx, row in enumerate(rows):
    cells = await row.locator('td').all()
    print(f"í–‰ {idx+1}: {len(cells)}ê°œ ì…€")
    
    cell_contents = []
    for i, cell in enumerate(cells):
        content = (await cell.inner_text()).strip()
        cell_contents.append(f"ì…€{i}: '{content}'")
    print(f"ì…€ ë‚´ìš©: {', '.join(cell_contents)}")
```

##### **STEP 2: ë§¤ì¥ë³„ êµ¬ì¡° íŒ¨í„´ ì •ì˜**
```python
# ë§¤ì¥ë³„ í…Œì´ë¸” êµ¬ì¡° ì •ì˜
STORE_TABLE_PATTERNS = {
    'A': {
        'my_history': {'coupon_name_cell': 0, 'quantity_cell': 1},
        'total_history': {'coupon_name_cell': 0, 'quantity_cell': 1},
        'selectors': ['#myDcList tr', '#allDcList tr']
    },
    'B': {
        'my_history': {'coupon_name_cell': 1, 'quantity_cell': None},  # í•­ìƒ 1ê°œ
        'total_history': {'coupon_name_cell': 1, 'quantity_cell': None},
        'selectors': ['tr.ev_dhx_skyblue', 'tr.odd_dhx_skyblue']
    },
    'C': {
        'my_history': {'coupon_name_cell': 2, 'quantity_cell': 3},
        'total_history': {'coupon_name_cell': 2, 'quantity_cell': 3},
        'selectors': ["tbody[id='discountlist'] tr"]
    }
}
```

##### **STEP 3: ì ì‘í˜• íŒŒì‹± ë¡œì§**
```python
def parse_coupon_row(cells, store_pattern, coupon_key_mapping):
    """ë§¤ì¥ë³„ íŒ¨í„´ì— ë§ëŠ” ì¿ í° í–‰ íŒŒì‹±"""
    if len(cells) <= store_pattern['coupon_name_cell']:
        return None, 0
    
    # ì¿ í°ëª… ì¶”ì¶œ
    name = (await cells[store_pattern['coupon_name_cell']].inner_text()).strip()
    
    # ìˆ˜ëŸ‰ ì¶”ì¶œ (ë§¤ì¥ë³„ ë¡œì§)
    if store_pattern['quantity_cell'] is None:
        quantity = 1  # Bë§¤ì¥: í•­ìƒ 1ê°œ
    else:
        quantity_text = (await cells[store_pattern['quantity_cell']].inner_text()).strip()
        quantity_match = re.search(r'(\d+)', quantity_text)
        quantity = int(quantity_match.group(1)) if quantity_match else 0
    
    # ì¿ í° í‚¤ ë§¤í•‘
    for coupon_name, coupon_key in coupon_key_mapping.items():
        if coupon_name in name:
            return coupon_key, quantity
    
    return None, 0
```

---

### **3. í˜ì´ì§€ ì•ˆì „ì„± ë¬¸ì œ**

#### **ì¦ìƒ**
```
âŒ Locator.all: Target page, context or browser has been closed
âŒ í˜ì´ì§€ êµ¬ì¡° ë¶„ì„ ì˜¤ë¥˜: Target page has been closed
```

#### **ì›ì¸**
- í˜ì´ì§€ ìƒíƒœ í™•ì¸ ì—†ì´ DOM ì¡°ì‘ ì‹œë„
- ë¸Œë¼ìš°ì € ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ë¯¸í¡

#### **í•´ê²° ë°©ë²•**

##### **í•„ìˆ˜ ì•ˆì „ì„± ê²€ì‚¬ íŒ¨í„´**
```python
async def safe_parse_operation(self):
    """ëª¨ë“  DOM ì ‘ê·¼ ì „ í•„ìˆ˜ ì•ˆì „ì„± ê²€ì‚¬"""
    try:
        # 1. í˜ì´ì§€ ë‹«í˜ ìƒíƒœ í™•ì¸
        if self.page.is_closed():
            self.logger.warning("í˜ì´ì§€ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤ - íŒŒì‹± ë¶ˆê°€")
            return {}
        
        # 2. URL ì ‘ê·¼ ê°€ëŠ¥ì„± í™•ì¸
        try:
            current_url = self.page.url
            self.logger.info(f"í˜„ì¬ í˜ì´ì§€ URL: {current_url}")
        except Exception as e:
            self.logger.warning(f"í˜ì´ì§€ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {str(e)}")
            return {}
        
        # 3. ì‹¤ì œ íŒŒì‹± ë¡œì§ ìˆ˜í–‰
        return await self._perform_parsing()
        
    except Exception as e:
        self.logger.error(f"ì•ˆì „ì„± ê²€ì‚¬ ì‹¤íŒ¨: {str(e)}")
        return {}
```

##### **ë¸Œë¼ìš°ì € ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**
```python
async def cleanup(self):
    """ë¸Œë¼ìš°ì € ë¦¬ì†ŒìŠ¤ ì •ë¦¬"""
    try:
        if self.page and not self.page.is_closed():
            await self.page.close()
        if self.context:
            await self.context.close()
        if self.browser:
            await self.browser.close()
        if self.playwright_instance:
            await self.playwright_instance.stop()
    except Exception as e:
        self.logger.warning(f"ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
```

---

### **4. ì¿ í° í‚¤ ë§¤í•‘ ì‹œìŠ¤í…œ**

#### **ì›ì¹™**
- ê° ë§¤ì¥ì˜ ì‹¤ì œ ì¿ í°ëª…ì„ í‘œì¤€ í‚¤ë¡œ ë§¤í•‘
- ì„¤ì • íŒŒì¼ì—ì„œ ì¤‘ì•™ ê´€ë¦¬
- í•˜ë“œì½”ë”© ê¸ˆì§€

#### **ì„¤ì • íŒŒì¼ êµ¬ì¡°**
```yaml
# store_config.yaml
selectors:
  coupons:
    coupon_key_mapping:
      "30ë¶„í• ì¸ê¶Œ(ë¬´ë£Œ)": "FREE_COUPON"
      "1ì‹œê°„í• ì¸ê¶Œ(ìœ ë£Œ)": "PAID_COUPON"
      "1ì‹œê°„ì£¼ë§í• ì¸ê¶Œ(ìœ ë£Œ)": "WEEKEND_COUPON"
    
    table_structure:
      description: "ë§¤ì¥ë³„ í…Œì´ë¸” êµ¬ì¡° ì„¤ëª…"
      coupon_name_cell_index: 0
      quantity_cell_index: 1
      has_my_history: true
```

#### **ë§¤í•‘ ë¡œë“œ ë° ì‚¬ìš©**
```python
# ì„¤ì •ì—ì„œ ë§¤í•‘ ë¡œë“œ
coupon_key_mapping = self.store_config.selectors.get('coupons', {}).get('coupon_key_mapping', {})

# ë§¤í•‘ ì ìš©
for coupon_name, coupon_key in coupon_key_mapping.items():
    if coupon_name in parsed_name:
        history[coupon_key] = history.get(coupon_key, 0) + quantity
        break
```

---

## ğŸ“‹ ìƒˆ ë§¤ì¥ ì¶”ê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸

### **ğŸ” ì‚¬ì „ ì¡°ì‚¬ ë‹¨ê³„**
```bash
â–¡ ë§¤ì¥ ì›¹ì‚¬ì´íŠ¸ êµ¬ì¡° ë¶„ì„
â–¡ ë¡œê·¸ì¸ í”Œë¡œìš° í™•ì¸
â–¡ ì°¨ëŸ‰ ê²€ìƒ‰ ë°©ì‹ íŒŒì•…
â–¡ ì¿ í° ì ìš© UI êµ¬ì¡° ë¶„ì„
â–¡ í• ì¸ ë‚´ì—­ í…Œì´ë¸” êµ¬ì¡° ë¶„ì„
```

### **âš™ï¸ ì„¤ì • íŒŒì¼ ì‘ì„±**
```bash
â–¡ store_config.yaml ìƒì„±
â–¡ ë¡œê·¸ì¸ ì •ë³´ ë° URL ì„¤ì •
â–¡ ì›¹ ì…€ë ‰í„° ì •ì˜
â–¡ ì¿ í° í‚¤ ë§¤í•‘ ì •ì˜
â–¡ í…Œì´ë¸” êµ¬ì¡° ì •ë³´ ì¶”ê°€
```

### **ğŸ—ï¸ í¬ë¡¤ëŸ¬ êµ¬í˜„**
```bash
â–¡ BaseCrawler ìƒì† êµ¬ì¡° ì‚¬ìš©
â–¡ í•„ìˆ˜ ë©”ì„œë“œ êµ¬í˜„ (login, search_vehicle, get_coupon_history, apply_coupons)
â–¡ ë§¤ì¥ë³„ HTML êµ¬ì¡°ì— ë§ëŠ” íŒŒì‹± ë¡œì§
â–¡ í˜ì´ì§€ ì•ˆì „ì„± ê²€ì‚¬ ì ìš©
â–¡ ì ì ˆí•œ ì˜ˆì™¸ ì²˜ë¦¬ ë° ë¡œê¹…
```

### **ğŸ”— ì–´ëŒ‘í„° í†µí•©**
```bash
â–¡ StoreAdapter ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
â–¡ store_registry.pyì— ë§¤ì¥ ë“±ë¡
â–¡ ConfigManager ì‚¬ìš© í™•ì¸
â–¡ í•„ìˆ˜ ì†ì„± ê²€ì¦ (discount_types, selectors ë“±)
```

### **âœ… í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
```bash
â–¡ E2E í…ŒìŠ¤íŠ¸ ì‘ì„± ë° ì‹¤í–‰
â–¡ ê° ë‹¨ê³„ë³„ ë¡œê¹… í™•ì¸
â–¡ ì¿ í° íŒŒì‹± ì •í™•ì„± ê²€ì¦
â–¡ í• ì¸ ê³„ì‚°ê¸° ì—°ë™ í™•ì¸
â–¡ ì—ëŸ¬ ìƒí™© í…ŒìŠ¤íŠ¸
```

---

## ğŸª ë§¤ì¥ë³„ íŠ¹ì„± ë¹„êµí‘œ

| ë§¤ì¥ | í…Œì´ë¸” ì‹ë³„ | í–‰ êµ¬ì¡° | ì¿ í°ëª… ìœ„ì¹˜ | ìˆ˜ëŸ‰ ìœ„ì¹˜ | íŠ¹ì´ì‚¬í•­ |
|------|-------------|---------|-------------|-----------|----------|
| **A** | ID ê¸°ë°˜ (`#myDcList`) | `[ì¿ í°ëª…, ìˆ˜ëŸ‰, ë²„íŠ¼]` | cell[0] | cell[1] | my/total êµ¬ì¡° ì°¨ì´ |
| **B** | í´ë˜ìŠ¤ ê¸°ë°˜ (`tr.ev_dhx_skyblue`) | `[ë²ˆí˜¸, í• ì¸ê°’, ë“±ë¡ì, ë‚ ì§œ]` | cell[1] | í•­ìƒ 1ê°œ | í´ë˜ìŠ¤ ê¸°ë°˜ ê°ì§€ |
| **C** | ID ê¸°ë°˜ (`tbody[id='discountlist']`) | `[ë²ˆí˜¸, ë‚ ì§œ, ì¿ í°ëª…, ìˆ˜ëŸ‰]` | cell[2] | cell[3] | í‘œì¤€ êµ¬ì¡° |
| **D** | ID ê¸°ë°˜ | `[ë‚ ì§œ, ì¿ í°ëª…, ìˆ˜ëŸ‰]` | cell[1] | cell[2] | ë‚ ì§œ í¬í•¨ |

---

## ğŸ› ï¸ ë¬¸ì œ ë°œìƒ ì‹œ ë””ë²„ê¹… ìˆœì„œ

### **1ë‹¨ê³„: ì„¤ì • ê²€ì¦**
```python
# ConfigManager ì‚¬ìš© í™•ì¸
assert isinstance(store_config, StoreConfig)
assert hasattr(store_config, 'discount_types')

# í•„ìˆ˜ ì„¤ì • ì¡´ì¬ í™•ì¸
assert store_config.selectors
assert 'coupons' in store_config.selectors
assert 'coupon_key_mapping' in store_config.selectors['coupons']
```

### **2ë‹¨ê³„: HTML êµ¬ì¡° ë¶„ì„**
```python
# ì‹¤ì œ í…Œì´ë¸” êµ¬ì¡° ì¶œë ¥
rows = await page.locator('table tr').all()
for i, row in enumerate(rows[:3]):  # ì²˜ìŒ 3ê°œ í–‰ë§Œ
    cells = await row.locator('td').all()
    print(f"í–‰ {i}: {[await cell.inner_text() for cell in cells]}")
```

### **3ë‹¨ê³„: íŒŒì‹± ë¡œì§ ê²€ì¦**
```python
# ë§¤í•‘ ê²°ê³¼ í™•ì¸
print(f"ì¿ í° í‚¤ ë§¤í•‘: {coupon_key_mapping}")
print(f"íŒŒì‹±ëœ ì´ë ¥: my_history={my_history}, total_history={total_history}")

# ë³€í™˜ ì „í›„ ë¹„êµ
print(f"ì›ë³¸ ì´ë ¥: {original_history}")
print(f"ë³€í™˜ í›„ ì´ë ¥: {converted_history}")
```

### **4ë‹¨ê³„: E2E ì—°ë™ í™•ì¸**
```python
# í• ì¸ ê³„ì‚°ê¸° ì…ë ¥ ê²€ì¦
print(f"ê³„ì‚°ê¸° ì…ë ¥ - ë‚´ ì´ë ¥: {my_history_by_key}")
print(f"ê³„ì‚°ê¸° ì…ë ¥ - ì „ì²´ ì´ë ¥: {total_history_by_key}")
print(f"ê³„ì‚°ê¸° ì¶œë ¥ - í•„ìš” ì¿ í°: {required_coupons}")
```

---

## ğŸš« ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ

### **âŒ í”¼í•´ì•¼ í•  íŒ¨í„´**
- ë§¤ì¥ë³„ë¡œ ê°œë³„ íŒŒì¼ ìƒì„± (ê³µí†µ ë¡œì§ ì‚¬ìš©)
- í•˜ë“œì½”ë”©ëœ ì…€ ì¸ë±ìŠ¤ ì‚¬ìš©
- í˜ì´ì§€ ìƒíƒœ í™•ì¸ ì—†ëŠ” DOM ì ‘ê·¼
- ì„œë¡œ ë‹¤ë¥¸ StoreConfig í´ë˜ìŠ¤ í˜¼ìš©
- ì„¤ì • íŒŒì¼ ì—†ëŠ” ë§¤ì¥ë³„ íŠ¹ìˆ˜ ë¡œì§

### **âœ… ê¶Œì¥ íŒ¨í„´**
- ConfigManagerë¥¼ í†µí•œ í†µì¼ëœ ì„¤ì • ë¡œë“œ
- ë§¤ì¥ë³„ íŒ¨í„´ì„ ì„¤ì • íŒŒì¼ì—ì„œ ì •ì˜
- ëª¨ë“  DOM ì ‘ê·¼ ì „ ì•ˆì „ì„± ê²€ì‚¬
- ê³µí†µ ì¸í„°í˜ì´ìŠ¤ ë° ì¶”ìƒ í´ë˜ìŠ¤ í™œìš©
- ì²´ê³„ì ì¸ ë¡œê¹… ë° ë””ë²„ê¹… ì½”ë“œ

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

### **í•µì‹¬ ì°¸ì¡° ë¬¸ì„œ**
- **ê¸°ë³¸ ì„¤ê³„**: `04_base_store_design.mdc`
- **ì—ëŸ¬ ì •ì±…**: `30_error_policy.mdc`
- **ì…€ë ‰í„° ê´€ë¦¬**: `20_selectors.mdc`
- **í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ**: `90_testing_lessons.mdc`

### **êµ¬í˜„ ì°¸ì¡° íŒŒì¼**
- **ì„¤ì • ê´€ë¦¬ì**: `infrastructure/config/config_manager.py`
- **ì–´ëŒ‘í„° ë ˆì§€ìŠ¤íŠ¸ë¦¬**: `adapters/store_registry.py`
- **ë² ì´ìŠ¤ í¬ë¡¤ëŸ¬**: `infrastructure/web_automation/base_crawler.py`
- **E2E í…ŒìŠ¤íŠ¸**: `tests/e2e/test_store_e2e.py`

---

## ğŸ’¡ ì„±ê³µ ì‚¬ë¡€ ìš”ì•½

ì´ ê°€ì´ë“œë¥¼ í†µí•´ í•´ê²°ëœ ì‹¤ì œ ë¬¸ì œë“¤:
- **A ë§¤ì¥**: ConfigManager í†µí•©ìœ¼ë¡œ `discount_types` ì†ì„± ì˜¤ë¥˜ í•´ê²°
- **B ë§¤ì¥**: í˜ì´ì§€ ì•ˆì „ì„± ê²€ì‚¬ë¡œ DOM ì ‘ê·¼ ì˜¤ë¥˜ í•´ê²°
- **C ë§¤ì¥**: í…Œì´ë¸” êµ¬ì¡° ë¶„ì„ìœ¼ë¡œ íŒŒì‹± ë¡œì§ ì •í™•ì„± í™•ë³´

ê° ë§¤ì¥ì˜ ê³ ìœ í•œ íŠ¹ì„±ì„ ì¡´ì¤‘í•˜ë©´ì„œë„ ê³µí†µëœ í•´ê²° íŒ¨í„´ì„ ì ìš©í•˜ì—¬ ì•ˆì •ì ì¸ ì‹œìŠ¤í…œ í†µí•©ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.